#!/usr/bin/env ruby

require "fileutils"
require "json"
require_relative "../lib/engine_list"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

FileUtils.chdir APP_ROOT do
  package_json = JSON.load_file("./package.json")
  dependencies = package_json["dependencies"]
  installed_engine_modules = dependencies
    .filter { |key, value| value.start_with?("portal:") }
    .keys
    .map { it.delete_prefix "toybox_" }

  added_engines = Toybox::ENGINE_LIST - installed_engine_modules
  removed_engines = installed_engine_modules - Toybox::ENGINE_LIST

  puts "== Adding #{added_engines.size} new engines to package.json =="
  added_engines.each do |engine_name|
    system!("yarn add toybox_#{engine_name}@portal:./engines/#{engine_name}")
  end

  puts "== Removing #{removed_engines.size} deleted engines from package.json =="
  removed_engines.each do |engine_name|
    system!("yarn remove toybox_#{engine_name}")
  end
end
